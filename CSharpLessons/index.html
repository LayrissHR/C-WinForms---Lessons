<!DOCTYPE html>
<html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Интерактивен Урок: Трислойна Архитектура</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                scroll-behavior: smooth;
            }
            .step-indicator {
                background-color: #4f46e5;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 1.2rem;
                flex-shrink: 0;
            }
            .code-block {
                background-color: #1e293b;
                color: #e2e8f0;
                padding: 1rem;
                border-radius: 0.5rem;
                position: relative;
                overflow-x: auto;
            }
            .code-block pre {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .copy-btn {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                background-color: #334155;
                color: #cbd5e1;
                border: none;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                cursor: pointer;
                font-size: 0.8rem;
            }
            .copy-btn:hover {
                background-color: #475569;
            }
            .winforms-window {
                border: 1px solid #9ca3af;
                border-radius: 8px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                background-color: #f9fafb;
            }
            .winforms-titlebar {
                background-color: #e5e7eb;
                padding: 6px 12px;
                border-top-left-radius: 7px;
                border-top-right-radius: 7px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 0.9rem;
                font-weight: 500;
            }
            .winforms-body {
                padding: 1.5rem;
            }
            .code-comment {
                color: #94a3b8; /* Lighter color for comments */
            }
            .button {
                background-color: #4f46e5;
                color: #f9fafb;
                width: auto;
                height: 3rem;
                margin-left: 45%;
                margin-right: 4%;
                padding: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-size: 1rem;
            }
        </style>
    </head>
    <body class="bg-slate-50 text-slate-800">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4">
                <h1 class="text-3xl font-bold text-indigo-600">
                    Интерактивен Урок: Трислойна Архитектура
                </h1>
                <p class="text-slate-600 mt-1">
                    Разделяй и владей: Как да пишем по-чист и организиран код в
                    C# и WinForms.
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-12">
            <!-- Introduction -->
            <section id="intro" class="mb-16">
                <div class="flex items-start gap-6">
                    <div class="step-indicator">1</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-3">
                            Какво е "Трислойна Архитектура"?
                        </h2>
                        <p class="mb-4">
                            Представете си, че разработвате приложение. В
                            началото е лесно - пишете целия код на едно място.
                            Но с времето приложението става по-голямо и кодът
                            става объркан. Става трудно да се намери нещо, да се
                            поправи грешка или да се добави нова функционалност.
                        </p>
                        <p class="mb-4">
                            Трислойната архитектура е начин да организираме кода
                            си, като го разделим на три основни, независими
                            слоя. Помислете за ресторант:
                        </p>
                        <div class="grid md:grid-cols-3 gap-6 mt-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-indigo-700">
                                    Presentation Layer (Сервитьор)
                                </h3>
                                <p class="text-sm mt-2">
                                    Това е потребителският интерфейс (вашата
                                    WinForms форма). Той приема "поръчката" от
                                    потребителя и му показва "готовата храна".
                                    Не знае как се готви.
                                </p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-emerald-700">
                                    Service Layer (Готвач)
                                </h3>
                                <p class="text-sm mt-2">
                                    Това е мозъкът на приложението. Той получава
                                    поръчката от сервитьора, следва "рецептата"
                                    (бизнес логиката), взима продукти от склада
                                    и приготвя ястието.
                                </p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-sky-700">
                                    Data Access Layer (Склад)
                                </h3>
                                <p class="text-sm mt-2">
                                    Това е мястото, където се съхраняват данните
                                    ("продуктите"). Неговата единствена работа е
                                    да дава и записва данни, когато готвачът
                                    поиска.
                                </p>
                            </div>
                        </div>
                        <p
                            class="mt-6 p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-r-lg"
                        >
                            <strong>Важно:</strong> Комуникацията е строго
                            йерархична! <strong>Сервитьорът</strong> говори само
                            с <strong>Готвача</strong>.
                            <strong>Готвачът</strong> говори със
                            <strong>Склада</strong>. Сервитьорът никога не влиза
                            директно в склада!
                        </p>
                    </div>
                </div>
            </section>

            <!-- The Problem -->
            <section id="problem" class="mb-16">
                <div class="flex items-start gap-6">
                    <div class="step-indicator">2</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-3">
                            Проблемът: Всичко на едно място
                        </h2>
                        <p class="mb-4">
                            Нека видим как изглежда код, който НЕ използва
                            слоеве. Цялата логика е "набутана" директно в
                            събитието на бутона `Click` във формата. Това е като
                            сервитьор, който се опитва едновременно да приема
                            поръчки, да готви и да тича до склада.
                        </p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)">
                                Копирай
                            </button>
                            <pre><code class="language-csharp">
<span class="code-comment">// Лошият начин - всичко е в Presentation Layer (WinForms)</span>
private void btnSave_Click(object sender, EventArgs e) <span class="code-comment">// Метод, който се изпълнява при клик на бутона</span>
{
    <span class="code-comment">// 1. Взимане на данни от UI</span>
    string name = txtProductName.Text; <span class="code-comment">// Вземи текста от полето за име на продукт</span>
    decimal price = decimal.Parse(txtPrice.Text); <span class="code-comment">// Вземи текста от полето за цена и го преобразувай в число</span>

    <span class="code-comment">// 2. Бизнес Валидация (работа на готвача)</span>
    if (string.IsNullOrWhiteSpace(name)) <span class="code-comment">// Провери дали името е празно или съдържа само интервали</span>
    {
        MessageBox.Show("Името на продукта не може да бъде празно."); <span class="code-comment">// Ако е празно, покажи съобщение за грешка</span>
        return; <span class="code-comment">// Прекрати изпълнението на метода</span>
    }
    if (price <= 0) <span class="code-comment">// Провери дали цената е по-малка или равна на нула</span>
    {
        MessageBox.Show("Цената трябва да е положително число."); <span class="code-comment">// Ако е така, покажи съобщение за грешка</span>
        return; <span class="code-comment">// Прекрати изпълнението на метода</span>
    }

    <span class="code-comment">// 3. Логика за достъп до данни (работа на склада)</span>
    <span class="code-comment">// Представете си тук сложен код за връзка с база данни...</span>
    Console.WriteLine($"Записване на продукт '{name}' в базата данни."); <span class="code-comment">// Симулираме запис в базата</span>
    
    MessageBox.Show("Продуктът е запазен успешно!"); <span class="code-comment">// Показваме съобщение за успех</span>
}
                        </code></pre>
                        </div>
                        <div
                            class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md"
                        >
                            <p>
                                <strong class="font-bold"
                                    >Защо това е лошо?</strong
                                >
                            </p>
                            <ul class="list-disc list-inside mt-2 text-sm">
                                <li>
                                    <strong>Трудно за четене:</strong> Логика от
                                    различен тип е смесена.
                                </li>
                                <li>
                                    <strong
                                        >Невъзможно за преизползване:</strong
                                    >
                                    Ако искате да запазите продукт от друго
                                    място (например от друг прозорец), трябва да
                                    копирате целия код.
                                </li>
                                <li>
                                    <strong>Трудно за тестване:</strong> Не
                                    можете лесно да тествате само бизнес
                                    валидацията, без да имате работеща форма.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- The Solution -->
            <section id="solution" class="mb-16">
                <div class="flex items-start gap-6">
                    <div class="step-indicator">3</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-3">
                            Решението: Разделяне на слоеве
                        </h2>
                        <p class="mb-4">
                            Сега ще създадем нашето мини-приложение, като
                            разделим кода на трите слоя. В реален проект, всеки
                            от тези класове ще бъде в отделен файл, за да е още
                            по-подредено.
                        </p>

                        <!-- Data Access Layer -->
                        <h3
                            class="text-xl font-semibold mt-8 mb-2 text-sky-700"
                        >
                            Стъпка 3.1: Data Access Layer (Нашият "фалшив"
                            склад)
                        </h3>
                        <p class="mb-4 text-sm">
                            Започваме от най-долния слой. Неговата единствена
                            цел е да управлява данните. Той е като склададжия -
                            давате му кашон (обект) и му казвате "запази го",
                            или го питате "имаме ли такъв кашон". Не го
                            интересува какво има в кашона. Тъй като не сте учили
                            за бази данни, нашият "склад" ще бъде обикновен
                            списък в паметта.
                        </p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)">
                                Копирай
                            </button>
                            <pre><code class="language-csharp">
<span class="code-comment">// Product.cs - Модел, който описва данните (това е "етикетът" на кашона)</span>
public class Product <span class="code-comment">// Декларираме клас, който ще описва един продукт</span>
{
    public string Name { get; set; } <span class="code-comment">// Свойство (property) за името на продукта</span>
    public decimal Price { get; set; } <span class="code-comment">// Свойство (property) за цената на продукта</span>
}

<span class="code-comment">// ProductRepository.cs - Нашият Data Access Layer ("склададжията")</span>
public class ProductRepository <span class="code-comment">// Декларираме клас, който ще управлява данните за продуктите</span>
{
    <span class="code-comment">// Симулираме база данни с обикновен статичен списък. 'static' означава, че този списък е един и същ за цялото приложение.</span>
    private static readonly List&lt;Product&gt; _products = new List&lt;Product&gt;();

    public void Add(Product product) <span class="code-comment">// Метод за добавяне на нов продукт</span>
    {
        _products.Add(product); <span class="code-comment">// Добавяме продукта към нашия списък</span>
        Console.WriteLine($"Продукт '{product.Name}' е добавен в 'базата данни'."); <span class="code-comment">// Изписваме съобщение в конзолата</span>
    }

    public bool Exists(string name) <span class="code-comment">// Метод, който проверява дали продукт със същото име вече съществува</span>
    {
        <span class="code-comment">// Използваме LINQ, за да проверим дали поне един елемент в списъка отговаря на условието</span>
        return _products.Any(p => p.Name.ToLower() == name.ToLower());
    }
}
                        </code></pre>
                        </div>

                        <!-- Service Layer -->
                        <h3
                            class="text-xl font-semibold mt-8 mb-2 text-emerald-700"
                        >
                            Стъпка 3.2: Service Layer (Готвачът с рецептата)
                        </h3>
                        <p class="mb-4 text-sm">
                            Това е нашият "мозък" или "главен готвач". Той
                            получава поръчката от сервитьора (данните от
                            формата) и изпълнява "рецептата". Рецептата включва:
                            <br />1. Проверка на продуктите (Валидация).
                            <br />2. Приготвяне на ястието (Създаване на обект).
                            <br />3. Извикване на склададжията, за да запише
                            какво е сготвено. <br />Той използва
                            `ProductRepository`, но не знае дали данните се
                            пазят в списък, файл или база данни. Него не го
                            интересува.
                        </p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)">
                                Копирай
                            </button>
                            <pre><code class="language-csharp">
<span class="code-comment">// ProductService.cs - Нашият Service Layer</span>
public class ProductService <span class="code-comment">// Декларираме клас, който ще съдържа бизнес логиката</span>
{
    <span class="code-comment">// Създаваме инстанция на репозиторито, за да можем да работим с данните</span>
    private readonly ProductRepository _productRepository = new ProductRepository();

    <span class="code-comment">// Метод за създаване на продукт, който приема име и цена</span>
    public void CreateProduct(string name, decimal price)
    {
        <span class="code-comment">// 1. Бизнес Валидация (Готвачът проверява продуктите)</span>
        if (string.IsNullOrWhiteSpace(name)) <span class="code-comment">// Проверяваме дали името е празно</span>
        {
            throw new Exception("Името на продукта не може да бъде празно."); <span class="code-comment">// Ако е, "хвърляме" грешка (exception), за да спрем процеса</span>
        }
        if (price <= 0) <span class="code-comment">// Проверяваме дали цената е отрицателна или нула</span>
        {
            throw new Exception("Цената трябва да е положително число."); <span class="code-comment">// Ако е, "хвърляме" грешка</span>
        }
        if (_productRepository.Exists(name)) <span class="code-comment">// Използваме репозиторито, за да проверим дали продуктът вече съществува</span>
        {
             throw new Exception("Продукт с такова име вече съществува."); <span class="code-comment">// Ако съществува, "хвърляме" грешка</span>
        }

        <span class="code-comment">// 2. Създаване на обекта (Готвачът приготвя ястието)</span>
        var product = new Product <span class="code-comment">// Създаваме нов обект от тип Product</span>
        {
            Name = name, <span class="code-comment">// Задаваме му име</span>
            Price = price <span class="code-comment">// Задаваме му цена</span>
        };

        <span class="code-comment">// 3. Извикване на Data Access Layer (Готвачът казва на склададжията да запише)</span>
        _productRepository.Add(product); <span class="code-comment">// Извикваме метода Add от репозиторито, за да запазим новия продукт</span>
    }
}
                        </code></pre>
                        </div>

                        <!-- Presentation Layer -->
                        <h3
                            class="text-xl font-semibold mt-8 mb-2 text-indigo-700"
                        >
                            Стъпка 3.3: Presentation Layer (Чистият сервитьор)
                        </h3>
                        <p class="mb-4 text-sm">
                            Накрая, работата на "сервитьора" (нашата WinForms
                            форма) става много лесна. Неговите задачи са само
                            две: <br />1. Да вземе поръчката от клиента (данните
                            от `TextBox`-овете). <br />2. Да я предаде на
                            готвача (`ProductService`). <br />Ако готвачът му
                            върне грешка ("свършиха доматите!"), сервитьорът
                            просто я предава на клиента (`MessageBox`). Той не
                            се интересува какви са бизнес правилата.
                        </p>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyCode(this)">
                                Копирай
                            </button>
                            <pre><code class="language-csharp">
<span class="code-comment">// Кодът в нашата WinForms форма</span>
public partial class ProductForm : Form <span class="code-comment">// Декларация на класа на нашата форма</span>
{
    <span class="code-comment">// Формата има "директна връзка" само със сървис слоя (сервитьорът говори само с готвача)</span>
    private readonly ProductService _productService = new ProductService();

    public ProductForm() <span class="code-comment">// Конструктор на формата, който се изпълнява при нейното създаване</span>
    {
        InitializeComponent(); <span class="code-comment">// Метод, който инициализира всички контроли върху формата (бутони, полета и т.н.)</span>
    }

    private void btnSave_Click(object sender, EventArgs e) <span class="code-comment">// Метод, който се изпълнява при клик на бутона</span>
    {
        try <span class="code-comment">// Опитваме се да изпълним операцията. 'try' е като "пробвай да предадеш поръчката"</span>
        {
            string name = txtProductName.Text; <span class="code-comment">// Вземи текста от полето за име</span>
            decimal price = decimal.Parse(txtPrice.Text); <span class="code-comment">// Вземи текста от полето за цена и го преобразувай в число</span>
            
            <span class="code-comment">// Просто извикваме услугата! Предаваме поръчката на готвача.</span>
            _productService.CreateProduct(name, price); <span class="code-comment">// Извикваме метода от нашия сървис, като му подаваме данните от формата</span>
            
            MessageBox.Show("Продуктът е запазен успешно!"); <span class="code-comment">// Ако готвачът не е върнал грешка, всичко е наред.</span>
        }
        catch (Exception ex) <span class="code-comment">// Ако готвачът е "хвърлил" грешка, ние я "хващаме" тук.</span>
        {
            <span class="code-comment">// Улавяме грешките, хвърлени от Service Layer, и ги показваме на клиента.</span>
            MessageBox.Show($"Грешка: {ex.Message}"); <span class="code-comment">// Показваме съобщението от грешката на потребителя</span>
        }
    }
}
                        </code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Interactive Demo -->
            <section id="demo" class="mb-16">
                <div class="flex items-start gap-6">
                    <div class="step-indicator">4</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-3">
                            Интерактивно Демо: Изпробвай сам!
                        </h2>
                        <p class="mb-6">
                            По-долу е симулация на нашето WinForms приложение.
                            Въведи данни и натисни "Запази", за да видиш как
                            Service Layer-ът работи в действие. Опитай да
                            въведеш невалидни данни (празно име, цена 0, или
                            същото име два пъти).
                        </p>
                        <p
                            class="text-sm p-3 bg-blue-50 border border-blue-200 rounded-md mb-6"
                        >
                            💡 <strong>Съвет:</strong> Отворете конзолата на
                            браузъра (с F12), за да видите съобщенията, които
                            нашият "фалшив" Data Access Layer изписва, когато
                            записва продукт!
                        </p>

                        <div class="winforms-window max-w-2xl mx-auto">
                            <div class="winforms-titlebar">
                                <span>Добавяне на нов продукт</span>
                                <span>&times;</span>
                            </div>
                            <div
                                class="winforms-body grid md:grid-cols-2 gap-8"
                            >
                                <!-- Input Form -->
                                <div>
                                    <div class="mb-4">
                                        <label
                                            for="productName"
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >Име на продукта:</label
                                        >
                                        <input
                                            type="text"
                                            id="productName"
                                            class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                        />
                                    </div>
                                    <div class="mb-6">
                                        <label
                                            for="productPrice"
                                            class="block text-sm font-medium text-gray-700 mb-1"
                                            >Цена:</label
                                        >
                                        <input
                                            type="number"
                                            id="productPrice"
                                            class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                        />
                                    </div>
                                    <button
                                        id="saveButton"
                                        class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                    >
                                        Запази
                                    </button>
                                    <div
                                        id="messageBox"
                                        class="mt-4 text-sm p-3 rounded-md"
                                        style="display: none"
                                    ></div>
                                </div>
                                <!-- Product List -->
                                <div>
                                    <h4
                                        class="font-semibold text-gray-800 border-b pb-2 mb-2"
                                    >
                                        Продукти в "базата данни":
                                    </h4>
                                    <div
                                        id="productList"
                                        class="text-sm text-gray-600 space-y-1"
                                    >
                                        <p class="text-gray-400 italic">
                                            Все още няма продукти.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Conclusion -->
            <section id="conclusion">
                <div class="flex items-start gap-6">
                    <div class="step-indicator">5</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-3">
                            Заключение и Предимства
                        </h2>
                        <p class="mb-4">
                            Поздравления! Вече знаете същността на трислойната
                            архитектура. Като разделихте кода, вие постигнахте:
                        </p>
                        <div
                            class="mt-4 p-4 bg-green-100 border-l-4 border-green-500 text-green-800 rounded-md"
                        >
                            <ul class="list-disc list-inside space-y-1">
                                <li>
                                    <strong>Преизползваемост:</strong> Можете да
                                    използвате `ProductService` навсякъде, не
                                    само в тази форма.
                                </li>
                                <li>
                                    <strong>Лесна поддръжка:</strong> Ако бизнес
                                    правило се промени, променяте го само на
                                    едно място - в Service Layer.
                                </li>
                                <li>
                                    <strong>Ясна структура:</strong> Кодът е
                                    организиран, чист и лесен за разбиране.
                                </li>
                                <li>
                                    <strong>Лесно тестване:</strong> Можете да
                                    тествате бизнес логиката в `ProductService`
                                    напълно независимо от потребителския
                                    интерфейс.
                                </li>
                            </ul>
                        </div>
                        <p class="mt-6">
                            Когато започнете да учите за бази данни, просто ще
                            замените нашия "фалшив" `ProductRepository` с
                            истински, който работи с SQL, и останалата част от
                            приложението ви няма да се нуждае от почти никакви
                            промени! Това е силата на добрата архитектура.
                        </p>
                    </div>
                </div>
            </section>
        </main>
        <a href="index2.html"
            ><button class="button">Към зачата за работа в клас</button></a
        >
        <footer
            class="text-center py-6 bg-slate-800 text-slate-400 text-sm mt-16"
        >
            <p>&copy; Интерактивен урок - инж. Пламена Янева</p>
        </footer>

        <script>
            // --- JavaScript за интерактивното демо ---

            // Слой 3: Data Access Layer (Симулация)
            const productRepository = {
                // Използваме масив, за да симулираме база данни
                _products: [],
                add: function (product) {
                    this._products.push(product);
                    console.log(
                        `[Data Access Layer] Продукт '${product.name}' е добавен.`
                    );
                },
                exists: function (name) {
                    const found = this._products.some(
                        (p) => p.name.toLowerCase() === name.toLowerCase()
                    );
                    console.log(
                        `[Data Access Layer] Проверка за съществуване на '${name}': ${found}`
                    );
                    return found;
                },
                getAll: function () {
                    return this._products;
                },
            };

            // Слой 2: Service Layer (Симулация)
            const productService = {
                createProduct: function (name, price) {
                    console.log(
                        "[Service Layer] Получена заявка за създаване на продукт."
                    );
                    // 1. Бизнес Валидация
                    if (!name || name.trim() === "") {
                        console.error(
                            "[Service Layer] Валидацията не премина: Името е празно."
                        );
                        throw new Error(
                            "Името на продукта не може да бъде празно."
                        );
                    }
                    const priceNumber = Number(price);
                    if (isNaN(priceNumber) || priceNumber <= 0) {
                        console.error(
                            "[Service Layer] Валидацията не премина: Цената не е валидна."
                        );
                        throw new Error(
                            "Цената трябва да е положително число."
                        );
                    }
                    console.log(
                        "[Service Layer] Извикване на Data Layer за проверка на съществуване..."
                    );
                    if (productRepository.exists(name)) {
                        console.error(
                            "[Service Layer] Валидацията не премина: Продуктът вече съществува."
                        );
                        throw new Error(
                            "Продукт с такова име вече съществува."
                        );
                    }

                    // 2. Създаване на обекта
                    const product = { name: name, price: priceNumber };
                    console.log(
                        "[Service Layer] Валидацията е успешна. Създаден е обект."
                    );

                    // 3. Извикване на Data Access Layer
                    console.log(
                        "[Service Layer] Извикване на Data Layer за запис."
                    );
                    productRepository.add(product);
                    console.log("[Service Layer] Процесът приключи успешно.");
                },
            };

            // Слой 1: Presentation Layer (Симулация на WinForms)
            const saveButton = document.getElementById("saveButton");
            const productNameInput = document.getElementById("productName");
            const productPriceInput = document.getElementById("productPrice");
            const messageBox = document.getElementById("messageBox");
            const productListDiv = document.getElementById("productList");

            saveButton.addEventListener("click", function () {
                // Това е еквивалентът на btnSave_Click
                try {
                    const name = productNameInput.value;
                    const price = productPriceInput.value;
                    console.log(
                        "[Presentation Layer] Бутонът 'Запази' е натиснат. Извикване на Service Layer..."
                    );

                    // Извикваме Service Layer
                    productService.createProduct(name, price);

                    // Показваме съобщение за успех
                    showMessage("Продуктът е запазен успешно!", "success");

                    // Изчистваме полетата
                    productNameInput.value = "";
                    productPriceInput.value = "";
                    productNameInput.focus();

                    // Обновяваме списъка с продукти
                    updateProductList();
                } catch (error) {
                    console.warn(
                        `[Presentation Layer] Хваната е грешка от Service Layer: ${error.message}`
                    );
                    // Показваме грешка от Service Layer
                    showMessage(`Грешка: ${error.message}`, "error");
                }
            });

            function showMessage(text, type) {
                messageBox.textContent = text;
                messageBox.style.display = "block";
                if (type === "success") {
                    messageBox.className =
                        "mt-4 text-sm p-3 rounded-md bg-green-100 text-green-800";
                } else {
                    messageBox.className =
                        "mt-4 text-sm p-3 rounded-md bg-red-100 text-red-800";
                }
            }

            function updateProductList() {
                const products = productRepository.getAll();
                if (products.length === 0) {
                    productListDiv.innerHTML =
                        '<p class="text-gray-400 italic">Все още няма продукти.</p>';
                } else {
                    productListDiv.innerHTML = "";
                    products.forEach((p) => {
                        const productElement = document.createElement("div");
                        productElement.textContent = `- ${
                            p.name
                        } (${p.price.toFixed(2)} лв.)`;
                        productListDiv.appendChild(productElement);
                    });
                }
            }

            // --- Помощна функция за копиране на код ---
            function copyCode(button) {
                const pre = button.nextElementSibling;
                const code = pre.querySelector("code");
                const text = code.innerText;

                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        button.textContent = "Копирано!";
                        setTimeout(() => {
                            button.textContent = "Копирай";
                        }, 2000);
                    })
                    .catch((err) => {
                        console.error("Неуспешно копиране: ", err);
                    });
            }
        </script>
    </body>
</html>
